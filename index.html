<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿Ÿè±¬&æ¿Ÿæ·¨çš„å…©äººç”Ÿæ´»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        var submitted = false;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?output=csv';
        let expenseChart;

        function handleIframeLoad() {
            if (submitted) {
                alert('âœ¨ ç´€éŒ„æˆåŠŸï¼è³‡æ–™å·²åŒæ­¥ âœ¨');
                location.reload();
            }
        }

        async function fetchData() {
            try {
                // å¼·åˆ¶åŠ ä¸Šéš¨æ©Ÿåƒæ•¸é¿å…å¿«å–
                const response = await fetch(`${csvUrl}&t=${Date.now()}`);
                const data = await response.text();
                const rows = data.split('\n').slice(1);

                let totalSpent = 0;
                let pigPaid = 0;
                let cleanPaid = 0;
                let categoryData = {};
                let recentHtml = "";

                // å…ˆéæ¿¾ç„¡æ•ˆåˆ—ä¸¦åè½‰ (æœ€æ–°åœ¨å¾Œ)
                const validRows = rows.filter(r => r.trim() !== "");
                
                validRows.reverse().forEach((row, index) => {
                    // å¼·åŒ–ç‰ˆ CSV è§£æ
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ""));
                    if (cols.length < 2) return;

                    const amount = parseFloat(cols[1]) || 0; 
                    const cat = cols[2] || "æœªåˆ†é¡";
                    const payer = cols[3] || "";             
                    const isSettled = cols[5] || ""; 

                    totalSpent += amount;
                    if (isSettled !== "æ˜¯") {
                        if (payer === "æ¿Ÿè±¬") pigPaid += amount;
                        if (payer === "æ¿Ÿæ·¨") cleanPaid += amount;
                    }

                    categoryData[cat] = (categoryData[cat] || 0) + amount;

                    if (index < 5) {
                        recentHtml += `
                            <div class="flex justify-between text-sm border-b py-3">
                                <div class="flex flex-col">
                                    <span class="font-medium text-gray-800">${cat}</span>
                                    <span class="text-[10px] text-gray-400">${cols[0].split(' ')[0]}</span>
                                </div>
                                <span class="font-bold text-indigo-600">$${amount} <span class="text-[10px] text-gray-400">(${payer})</span></span>
                            </div>`;
                    }
                });

                document.getElementById('wallet-balance').innerText = '$' + (15000 - totalSpent).toLocaleString();
                document.getElementById('pig-reimbursement').innerText = '$' + pigPaid.toLocaleString();
                document.getElementById('clean-reimbursement').innerText = '$' + cleanPaid.toLocaleString();
                document.getElementById('recent-list').innerHTML = recentHtml || "<p class='text-center py-4 text-gray-400'>å°šç„¡ç´€éŒ„</p>";

                // ç¢ºä¿ Chart.js è¼‰å…¥å¾Œå†ç¹ªåœ–
                setTimeout(() => updateChart(categoryData), 500);
            } catch (e) { 
                console.error("è³‡æ–™è®€å–éŒ¯èª¤:", e);
                document.getElementById('recent-list').innerHTML = "è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–é€£çµã€‚";
            }
        }

        function updateChart(catData) {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            
            if (expenseChart) expenseChart.destroy();
            
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catData),
                    datasets: [{
                        data: Object.values(catData),
                        backgroundColor: ['#6366f1', '#f87171', '#fbbf24', '#34d399', '#a78bfa', '#f472b6'],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } 
                    } 
                }
            });
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'border-indigo-600', 'text-indigo-600'));
            
            document.getElementById(tabName).classList.add('active');
            const activeBtn = document.getElementById('btn-' + tabName);
            activeBtn.classList.add('active', 'border-indigo-600', 'text-indigo-600');
        }

        window.onload = fetchData;
    </script>

    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <header class="bg-white shadow-sm sticky top-0 z-10 border-b border-gray-100">
        <div class="max-w-md mx-auto px-4 py-4 text-center">
            <h1 class="text-lg font-black text-gray-800 tracking-tight">ğŸ· æ¿Ÿè±¬ & æ·¨æ·¨çš„ç”Ÿæ´» ğŸ¯</h1>
            <nav class="flex justify-around mt-4">
                <button onclick="openTab('money')" id="btn-money" class="tab-btn active border-b-2 border-indigo-600 text-indigo-600 pb-2 px-4 font-bold transition-all">é‡‘éŒ¢</button>
                <button onclick="openTab('mission')" id="btn-mission" class="tab-btn pb-2 px-4 font-bold text-gray-400 transition-all">ä»»å‹™</button>
                <button onclick="openTab('body')" id="btn-body" class="tab-btn pb-2 px-4 font-bold text-gray-400 transition-all">é«”é­„</button>
            </nav>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-24">
        <section id="money" class="tab-content active">
            <div class="bg-gradient-to-br from-indigo-600 to-violet-700 text-white p-6 rounded-3xl shadow-xl mb-6">
                <p class="text-xs font-medium opacity-80 mb-1 italic">Monthly Wallet Balance</p>
                <p id="wallet-balance" class="text-4xl font-black">...</p>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <span class="bg-indigo-100 p-1.5 rounded-lg mr-2">ğŸ“Š</span> æ”¯å‡ºæ¯”ä¾‹åˆ†æ
                </h3>
                <div class="relative h-64">
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl border-l-4 border-rose-400 shadow-sm">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">æ‡‰æ’¥çµ¦æ¿Ÿè±¬</p>
                    <p id="pig-reimbursement" class="text-xl font-black text-gray-800">$0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl border-l-4 border-sky-400 shadow-sm">
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">æ‡‰æ’¥çµ¦æ¿Ÿæ·¨</p>
                    <p id="clean-reimbursement" class="text-xl font-black text-gray-800">$0</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 mb-6">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                    <span class="bg-amber-100 p-1.5 rounded-lg mr-2">ğŸ“œ</span> æœ€è¿‘ 5 ç­†èŠ±è²»
                </h3>
                <div id="recent-list" class="space-y-1 text-gray-600">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-200">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <span class="bg-emerald-100 p-1.5 rounded-lg mr-2">âœï¸</span> æ–°å¢ç´€éŒ„
                </h3>
                <form action="https://docs.google.com/forms/u/1/d/e/1FAIpQLSd3pRv9-m4Tkd0duGqCn3YkUb_cTYz2oP3GY5Ht5WwPOVG1KA/formResponse" 
                      method="POST" target="hidden_iframe" onsubmit="submitted=true;">
                    <input type="date" name="entry.2029544290" class="w-full bg-gray-50 border-gray-100 border p-3 rounded-xl mb-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" required>
                    <input type="number" name="entry.1782400014" placeholder="è¼¸å…¥é‡‘é¡" class="w-full bg-gray-50 border-gray-100 border p-3 rounded-xl mb-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" required>
                    <select name="entry.1539739800" class="w-full bg-gray-50 border-gray-100 border p-3 rounded-xl mb-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="é£²é£Ÿ">ğŸ• é£²é£Ÿ</option>
                        <option value="æ—¥ç”¨">ğŸ§º æ—¥ç”¨</option>
                        <option value="è¨­å‚™">ğŸ’» è¨­å‚™</option>
                        <option value="æ—…éŠ">âœˆï¸ æ—…éŠ</option>
                        <option value="ç¤¾äº¤">ğŸ¥‚ ç¤¾äº¤</option>
                    </select>
                    <div class="flex justify-around bg-gray-50 p-3 rounded-xl mb-4">
                        <label class="text-xs font-bold cursor-pointer"><input type="radio" name="entry.1122156127" value="æ¿Ÿè±¬" required> æ¿Ÿè±¬</label>
                        <label class="text-xs font-bold cursor-pointer"><input type="radio" name="entry.1122156127" value="æ¿Ÿæ·¨"> æ¿Ÿæ·¨</label>
                        <label class="text-xs font-bold cursor-pointer"><input type="radio" name="entry.1122156127" value="å…±åŒéŒ¢åŒ…"> å…±åŒ</label>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition-colors">åoçˆ»è¨˜éŒ„ä¸€ç­†oå</button>
                </form>
            </div>
        </section>

        <section id="mission" class="tab-content text-center py-20 text-gray-400">ä»»å‹™åŠŸèƒ½æ­£åœ¨è¶•å·¥ä¸­...</section>
        <section id="body" class="tab-content text-center py-20 text-gray-400">é«”é­„åŠŸèƒ½æ­£åœ¨è¶•å·¥ä¸­...</section>
    </main>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="handleIframeLoad()"></iframe>
</body>
</html>
