<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>濟豬&濟淨的兩人生活</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: #ffffff; border: 2px solid #e2e8f0; box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.05); border-radius: 1.5rem; }
        @keyframes starBlink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(1.2); } }
        .pixel-star { display: inline-block; animation: starBlink 2s infinite; color: #fbbf24; }
        .payer-option { display: none; }
        .payer-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border-radius: 12px; font-weight: 700; font-size: 14px; background: #f1f5f9; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .payer-option:checked + .payer-label { background: #1e293b; color: white; transform: translateY(-2px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tag-pig { color: #c2410c; background: #fff7ed; border-radius: 6px; padding: 2px 8px; font-weight: 700; }
        .tag-clean { color: #0369a1; background: #f0f9ff; border-radius: 6px; padding: 2px 8px; font-weight: 700; }
        .tag-settled { color: #64748b; background: #f1f5f9; text-decoration: line-through; opacity: 0.6; }
    </style>

    <script>
        var submitted = false;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?output=csv';
        let expenseChart;

        // 註冊 DataLabels 外掛
        Chart.register(ChartDataLabels);

        window.handleIframeLoad = function() {
            if (submitted) {
                alert('✨ 紀錄存檔成功！ ✧*｡٩(ˊᗜˋ*)و✧*｡ ✨');
                location.reload();
            }
        };

        async function fetchData() {
            try {
                const response = await fetch(`${csvUrl}&t=${Date.now()}`);
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
                
                let income = 15000; 
                let totalExpense = 0; 
                let walletPaid = 0; 
                let settledReimbursements = 0; 
                let pigOwed = 0; 
                let cleanOwed = 0; 
                let categoryData = {};
                let recentHtml = "";

                rows.forEach(r => {
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ""));
                    const amt = parseFloat(c[1]) || 0;
                    const payer = c[3];
                    const cat = c[2];
                    const isSettled = c[5] === "是";

                    if (cat === "收入" || amt < 0) {
                        income += Math.abs(amt);
                    } else {
                        totalExpense += amt;
                        categoryData[cat] = (categoryData[cat] || 0) + amt;
                        if (payer === "共同錢包") { walletPaid += amt; } 
                        else {
                            if (isSettled) { settledReimbursements += amt; } 
                            else {
                                if (payer === "濟豬") pigOwed += amt;
                                if (payer === "濟淨") cleanOwed += amt;
                            }
                        }
                    }
                });

                const currentBalance = income - walletPaid - settledReimbursements;
                document.getElementById('wallet-balance').innerText = currentBalance.toLocaleString();
                document.getElementById('pig-reimbursement').innerText = '$' + pigOwed.toLocaleString();
                document.getElementById('clean-reimbursement').innerText = '$' + cleanOwed.toLocaleString();

                [...rows].reverse().slice(0, 5).forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ""));
                    const amt = parseFloat(cols[1]) || 0;
                    const isSettled = cols[5] === "是";
                    if (cols[2] === "收入") return;

                    recentHtml += `
                        <div class="flex justify-between items-center py-4 border-b border-slate-100 last:border-0 ${isSettled ? 'opacity-40' : ''}">
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${cols[2]} ${isSettled ? '✅' : ''}</div>
                                <div class="text-[11px] text-slate-500 font-medium">${cols[4]}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-slate-900 text-lg">$${amt.toLocaleString()}</div>
                                <span class="text-[10px] ${isSettled ? 'tag-settled' : (cols[3]==='濟豬'?'tag-pig':'tag-clean')}">${cols[3]}</span>
                            </div>
                        </div>`;
                });
                document.getElementById('recent-list').innerHTML = recentHtml || "尚未有紀錄";

                renderChart(categoryData, totalExpense);
            } catch (e) { console.error(e); }
        }

        function renderChart(catData, grandTotal) {
            const ctx = document.getElementById('expenseChart');
            if (expenseChart) expenseChart.destroy();
            
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catData).map(k => `${k} (${((catData[k]/grandTotal)*100).toFixed(0)}%)`),
                    datasets: [{
                        data: Object.values(catData),
                        backgroundColor: ['#818cf8', '#f87171', '#fbbf24', '#34d399', '#f472b6', '#cbd5e1'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 12, weight: '700' } } },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value) => value > 0 ? `$${value.toLocaleString()}` : '', // 直接在圓餅上顯示金額
                            display: 'auto'
                        }
                    }
                },
                plugins: [{
                    beforeDraw: (chart) => {
