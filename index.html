<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿Ÿè±¬&æ¿Ÿæ·¨çš„å…©äººç”Ÿæ´»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        var submitted = false;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?output=csv';
        let expenseChart;

        window.handleIframeLoad = function() {
            if (submitted) {
                alert('âœ¨ ç´€éŒ„æˆåŠŸï¼è³‡æ–™å·²é£›å‘é›²ç«¯ âœ¨');
                window.location.reload();
            }
        };

        function handleFormSubmit() {
            submitted = true;
            const btn = document.getElementById('submit-btn');
            if(btn) { btn.innerText = "å‚³é€ä¸­..."; btn.disabled = true; }
        }

        async function fetchData() {
            try {
                const response = await fetch(csvUrl + '&t=' + new Date().getTime());
                const data = await response.text();
                const rows = data.split('\n').slice(1);

                let totalSpent = 0;
                let pigPaid = 0;
                let cleanPaid = 0;
                let categoryData = {};
                let recentHtml = "";

                rows.reverse().forEach((row, index) => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ""));
                    if (cols.length < 2) return;

                    const amount = parseFloat(cols[1]) || 0; 
                    const cat = cols[2] || "æœªåˆ†é¡";
                    const payer = cols[3] || "";             
                    const isSettled = cols[5] || ""; 

                    totalSpent += amount;
                    if (isSettled !== "æ˜¯") {
                        if (payer === "æ¿Ÿè±¬") pigPaid += amount;
                        if (payer === "æ¿Ÿæ·¨") cleanPaid += amount;
                    }

                    // æ”¶é›†åœ“é¤…åœ–æ•¸æ“š
                    categoryData[cat] = (categoryData[cat] || 0) + amount;

                    // è£½ä½œæœ€è¿‘ 5 ç­†æ¸…å–®
                    if (index < 5) {
                        recentHtml += `<div class="flex justify-between text-sm border-b py-2">
                            <span>${cols[4]} ${cat}</span>
                            <span class="font-bold text-gray-700">$${amount} (${payer})</span>
                        </div>`;
                    }
                });

                // æ›´æ–°æ•¸å­—
                document.getElementById('wallet-balance').innerText = '$' + (15000 - totalSpent);
                document.getElementById('pig-reimbursement').innerText = '$' + pigPaid;
                document.getElementById('clean-reimbursement').innerText = '$' + cleanPaid;
                document.getElementById('recent-list').innerHTML = recentHtml;

                updateChart(categoryData);
                console.log("âœ… æ•¸æ“šèˆ‡åœ–è¡¨æ›´æ–°å®Œæˆ");
            } catch (e) { console.error("è®€å–å¤±æ•—:", e); }
        }

        function updateChart(catData) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChart) expenseChart.destroy();
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catData),
                    datasets: [{
                        data: Object.values(catData),
                        backgroundColor: ['#6366f1', '#f87171', '#fbbf24', '#34d399', '#a78bfa']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.getElementById('btn-' + tabName).classList.add('active');
        }

        window.onload = fetchData;
    </script>

    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { border-bottom: 4px solid #6366f1; color: #6366f1; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-md mx-auto px-4 py-4 text-center">
            <h1 class="text-xl font-bold text-gray-800">æ¿Ÿè±¬ & æ¿Ÿæ·¨çš„å…©äººç”Ÿæ´»</h1>
            <nav class="flex justify-around mt-4">
                <button onclick="openTab('mission')" id="btn-mission" class="tab-btn pb-2 px-2 font-bold text-gray-500">ä»»å‹™</button>
                <button onclick="openTab('money')" id="btn-money" class="tab-btn active pb-2 px-2 font-bold text-gray-500">é‡‘éŒ¢</button>
                <button onclick="openTab('body')" id="btn-body" class="tab-btn pb-2 px-2 font-bold text-gray-500">é«”é­„</button>
            </nav>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-20">
        <section id="money" class="tab-content active">
            <div class="bg-indigo-600 text-white p-5 rounded-2xl shadow-lg text-center mb-6">
                <p class="text-xs opacity-80">æœ¬æœˆå…±åŒéŒ¢åŒ…é¤˜é¡</p>
                <p id="wallet-balance" class="text-3xl font-bold mt-1">è¼‰å…¥ä¸­...</p>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm mb-6">
                <h3 class="font-bold mb-4 text-gray-700 text-center">ğŸ“Š æ”¯å‡ºæ¯”ä¾‹</h3>
                <canvas id="expenseChart" width="200" height="200"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400 text-center">
                    <p class="text-[10px] text-gray-500 uppercase">æ‡‰æ’¥çµ¦æ¿Ÿè±¬</p>
                    <p id="pig-reimbursement" class="text-lg font-bold text-gray-800">$0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-400 text-center">
                    <p class="text-[10px] text-gray-500 uppercase">æ‡‰æ’¥çµ¦æ¿Ÿæ·¨</p>
                    <p id="clean-reimbursement" class="text-lg font-bold text-gray-800">$0</p>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm mb-6">
                <h3 class="font-bold mb-2 text-gray-700">ğŸ“œ æœ€è¿‘ 5 ç­†èŠ±è²»</h3>
                <div id="recent-list" class="divide-y text-gray-600">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                <h3 class="font-bold mb-4 text-gray-700">ğŸ“ æ–°å¢ç´€éŒ„</h3>
                <form action="https://docs.google.com/forms/u/1/d/e/1FAIpQLSd3pRv9-m4Tkd0duGqCn3YkUb_cTYz2oP3GY5Ht5WwPOVG1KA/formResponse" 
                      method="POST" target="hidden_iframe" onsubmit="handleFormSubmit();">
                    <input type="date" name="entry.2029544290" class="w-full border-gray-200 border p-2 rounded-lg mb-3 text-sm" required>
                    <input type="number" name="entry.1782400014" placeholder="é‡‘é¡" class="w-full border-gray-200 border p-2 rounded-lg mb-3 text-sm" required>
                    <select name="entry.1539739800" class="w-full border-gray-200 border p-2 rounded-lg mb-3 text-sm">
                        <option value="é£²é£Ÿ">é£²é£Ÿ</option><option value="æ—¥ç”¨">æ—¥ç”¨</option>
                        <option value="è¨­å‚™">è¨­å‚™</option><option value="æ—…éŠ">æ—…éŠ</option>
                        <option value="ç¤¾äº¤">ç¤¾äº¤</option>
                    </select>
                    <div class="flex justify-between bg-gray-50 p-2 rounded-lg mb-4">
                        <label class="text-xs"><input type="radio" name="entry.1122156127" value="æ¿Ÿè±¬" required> æ¿Ÿè±¬</label>
                        <label class="text-xs"><input type="radio" name="entry.1122156127" value="æ¿Ÿæ·¨"> æ¿Ÿæ·¨</label>
                        <label class="text-xs"><input type="radio" name="entry.1122156127" value="å…±åŒéŒ¢åŒ…"> å…±åŒ</label>
                    </div>
                    <button id="submit-btn" type="submit" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-bold shadow-md">åoçˆ»è¨˜éŒ„ä¸€ç­†oå</button>
                </form>
            </div>
        </section>

        <section id="mission" class="tab-content text-center py-10"><p class="text-gray-400">ä»»å‹™åŠŸèƒ½é–‹ç™¼ä¸­...</p></section>
        <section id="body" class="tab-content text-center py-10"><p class="text-gray-400">é«”é­„åŠŸèƒ½é–‹ç™¼ä¸­...</p></section>
    </main>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(window.handleIframeLoad) handleIframeLoad()"></iframe>
</body>
</html>
