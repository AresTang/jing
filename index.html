<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>濟豬&濟淨的兩人生活</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* 像素中二風格裝飾 */
        .pixel-border {
            border: 3px solid #000;
            box-shadow: 4px 4px 0px #000;
        }
        .pixel-btn:active {
            box-shadow: 1px 1px 0px #000;
            transform: translate(2px, 2px);
        }
        .tag-pig { background-color: #ffedd5; color: #ea580c; border: 1px solid #fdba74; } /* 橘紅 */
        .tag-clean { background-color: #e0f2fe; color: #0284c7; border: 1px solid #7dd3fc; } /* 水藍 */
        .tag-common { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; } /* 共同 */
    </style>

    <script>
        var submitted = false;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?output=csv';
        let expenseChart;

        window.handleIframeLoad = function() {
            if (submitted) {
                alert('✨ 紀錄成功！卍o爻錢錢飛走了爻o卍 ✨');
                location.reload();
            }
        };

        async function fetchData() {
            try {
                const response = await fetch(`${csvUrl}&t=${Date.now()}`);
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
                
                let totalSpent = 0;
                let pigPaid = 0;
                let cleanPaid = 0;
                let categoryData = {};
                let recentHtml = "";

                const reversedRows = [...rows].reverse();
                rows.forEach(r => {
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ""));
                    totalSpent += parseFloat(c[1]) || 0;
                });

                reversedRows.forEach((row, index) => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ""));
                    if (cols.length < 2) return;

                    const amount = parseFloat(cols[1]) || 0; 
                    const cat = cols[2] || "未分類";
                    const payer = cols[3] || "";             
                    const expenseDate = cols[4] || "無日期";
                    const isSettled = cols[5] || ""; 

                    if (isSettled !== "是") {
                        if (payer === "濟豬") pigPaid += amount;
                        if (payer === "濟淨") cleanPaid += amount;
                    }

                    categoryData[cat] = (categoryData[cat] || 0) + amount;

                    if (index < 5) {
                        let tagClass = payer === "濟豬" ? "tag-pig" : (payer === "濟淨" ? "tag-clean" : "tag-common");
                        recentHtml += `
                            <div class="flex justify-between items-center py-3 border-b border-black/5">
                                <div>
                                    <div class="font-bold text-gray-900">${cat}</div>
                                    <div class="text-[11px] text-gray-400 font-medium">${expenseDate}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-black text-lg">$${amount.toLocaleString()}</div>
                                    <span class="text-[10px] px-2 py-0.5 rounded ${tagClass}">${payer}</span>
                                </div>
                            </div>`;
                    }
                });

                document.getElementById('wallet-balance').innerText = '$' + (15000 - totalSpent).toLocaleString();
                document.getElementById('pig-reimbursement').innerText = '$' + pigPaid.toLocaleString();
                document.getElementById('clean-reimbursement').innerText = '$' + cleanPaid.toLocaleString();
                document.getElementById('recent-list').innerHTML = recentHtml || "尚未有任何傳說紀錄";

                renderChart(categoryData, totalSpent);
            } catch (e) { console.error(e); }
        }

        function renderChart(catData, grandTotal) {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            if (expenseChart) expenseChart.destroy();

            // 計算百分比標籤
            const labels = Object.keys(catData).map(key => {
                const percentage = ((catData[key] / grandTotal) * 100).toFixed(1);
                return `${key} (${percentage}%)`;
            });

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: Object.values(catData),
                        backgroundColor: ['#6366f1', '#f87171', '#fbbf24', '#34d399', '#a78bfa', '#f472b6'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: { 
                        legend: { position: 'bottom', labels: { usePointStyle
